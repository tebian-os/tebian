#!/bin/bash
# Tebian First Boot Onboarding
# Runs once on first login, asks user their preferred experience

# Security: restrictive umask for created files
umask 077

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [ -f "$SCRIPT_DIR/tebian-common" ]; then
    source "$SCRIPT_DIR/tebian-common"
elif [ -f "$HOME/.local/bin/tebian-common" ]; then
    source "$HOME/.local/bin/tebian-common"
fi

get_term() {
    if command -v kitty &>/dev/null; then echo "kitty -e"
    elif command -v foot &>/dev/null; then echo "foot -e"
    elif command -v alacritty &>/dev/null; then echo "alacritty -e"
    elif command -v xterm &>/dev/null; then echo "xterm -e"
    else echo "kitty -e"
    fi
}
TERM_CMD=$(get_term)

ONBOARD_FILE="$HOME/.config/tebian-onboarded"
LOG_FILE="$HOME/.local/share/tebian-onboard.log"

log() {
    echo "[$(date)] $1" >> "$LOG_FILE"
}

if [ -f "$ONBOARD_FILE" ]; then
    log "Already onboarded, exiting"
    exit 0
fi

PROGRESS_FILE="$HOME/.config/tebian/.onboard_in_progress"

mkdir -p "$HOME/.local/share"
mkdir -p "$HOME/.config/environment.d"
mkdir -p "$HOME/.config/tebian"
chmod 700 "$HOME/.config/tebian"

# Resume detection: if previous run crashed mid-install
if [ -f "$PROGRESS_FILE" ]; then
    PREV_CHOICE=$(cat "$PROGRESS_FILE" 2>/dev/null)
    log "Resuming interrupted onboarding (was: $PREV_CHOICE)"
    CHOICE="$PREV_CHOICE"
else
    log "Starting onboarding"
    CHOICE=$(echo -e "Base (Minimal)\nDesktop (Familiar)" | tfuzzel -d -p "  Welcome to Tebian | " --lines=2)
fi

if [[ "$CHOICE" =~ "Desktop" ]]; then
    log "User chose Desktop mode"
    echo "Desktop" > "$PROGRESS_FILE"

    notify-send "Tebian" "Setting up Desktop mode..." 2>/dev/null || true
    
    $TERM_CMD bash -c '
        # Source shared functions
        source "$HOME/.local/bin/tebian-common" 2>/dev/null

        echo "========================================="
        echo "  Tebian Desktop Setup"
        echo "========================================="
        echo ""
        echo "Your password is needed to install packages."
        echo ""

        # Prompt for password up front and cache it
        sudo -v || { echo "Authentication failed. Exiting."; read -p "Press Enter..."; exit 1; }
        echo ""

        # Check network connectivity
        if ! ping -c1 -W3 1.1.1.1 &>/dev/null; then
            echo "⚠️  No network connection detected."
            echo "   Connect to WiFi first (Super+D > WiFi)."
            read -p "Press Enter to exit..."
            exit 1
        fi

        # === SYSTEM CONFIGURATION ===
        echo "========================================="
        echo "  System Configuration"
        echo "========================================="
        echo ""

        # Timezone
        CURRENT_TZ=$(timedatectl show --property=Timezone --value 2>/dev/null || cat /etc/timezone 2>/dev/null || echo "UTC")
        echo "  Current timezone: $CURRENT_TZ"
        read -p "  Change timezone? [y/N]: " tz_change
        if [[ "$tz_change" =~ ^[Yy] ]]; then
            echo "  Available timezones (common):"
            echo "    1) America/New_York    2) America/Chicago"
            echo "    3) America/Denver      4) America/Los_Angeles"
            echo "    5) Europe/London       6) Europe/Berlin"
            echo "    7) Asia/Tokyo          8) Australia/Sydney"
            echo "    9) Other (type manually)"
            read -p "  Select [1-9]: " tz_pick
            case "$tz_pick" in
                1) NEW_TZ="America/New_York" ;;
                2) NEW_TZ="America/Chicago" ;;
                3) NEW_TZ="America/Denver" ;;
                4) NEW_TZ="America/Los_Angeles" ;;
                5) NEW_TZ="Europe/London" ;;
                6) NEW_TZ="Europe/Berlin" ;;
                7) NEW_TZ="Asia/Tokyo" ;;
                8) NEW_TZ="Australia/Sydney" ;;
                9) read -p "  Enter timezone (e.g. America/New_York): " NEW_TZ ;;
                *) NEW_TZ="" ;;
            esac
            if [ -n "$NEW_TZ" ] && [ -f "/usr/share/zoneinfo/$NEW_TZ" ]; then
                sudo timedatectl set-timezone "$NEW_TZ"
                echo "  ✓ Timezone set to $NEW_TZ"
            elif [ -n "$NEW_TZ" ]; then
                echo "  ✗ Invalid timezone: $NEW_TZ (keeping $CURRENT_TZ)"
            fi
        fi
        echo ""

        # Hostname
        CURRENT_HOST=$(hostname)
        echo "  Current hostname: $CURRENT_HOST"
        read -p "  Change hostname? [y/N]: " host_change
        if [[ "$host_change" =~ ^[Yy] ]]; then
            read -p "  Enter new hostname: " NEW_HOST
            if [[ "$NEW_HOST" =~ ^[a-zA-Z0-9]([a-zA-Z0-9-]*[a-zA-Z0-9])?$ ]]; then
                sudo hostnamectl set-hostname "$NEW_HOST"
                echo "  ✓ Hostname set to $NEW_HOST"
            else
                echo "  ✗ Invalid hostname (letters, numbers, hyphens only)"
            fi
        fi
        echo ""

        # Keyboard layout
        CURRENT_LAYOUT=$(localectl status 2>/dev/null | grep "X11 Layout" | awk "{print \$3}")
        [ -z "$CURRENT_LAYOUT" ] && CURRENT_LAYOUT="us"
        echo "  Current keyboard layout: $CURRENT_LAYOUT"
        read -p "  Change keyboard layout? [y/N]: " kb_change
        if [[ "$kb_change" =~ ^[Yy] ]]; then
            echo "  Common layouts: us, gb, de, fr, es, it, pt, ru, jp, kr"
            read -p "  Enter layout code: " NEW_LAYOUT
            if [ -n "$NEW_LAYOUT" ]; then
                sudo localectl set-x11-keymap "$NEW_LAYOUT"
                # Also set for Sway
                mkdir -p "$HOME/.config/sway"
                sed -i "/input.*keyboard/,/}/ s/xkb_layout.*/xkb_layout $NEW_LAYOUT/" "$HOME/.config/sway/config" 2>/dev/null || true
                echo "  ✓ Keyboard layout set to $NEW_LAYOUT"
            fi
        fi

        echo ""

        # Locale
        CURRENT_LOCALE=$(locale 2>/dev/null | grep "^LANG=" | cut -d= -f2)
        [ -z "$CURRENT_LOCALE" ] && CURRENT_LOCALE="en_US.UTF-8"
        echo "  Current locale: $CURRENT_LOCALE"
        read -p "  Change locale? [y/N]: " locale_change
        if [[ "$locale_change" =~ ^[Yy] ]]; then
            echo "  Common locales:"
            echo "    1) en_US.UTF-8   2) en_GB.UTF-8"
            echo "    3) de_DE.UTF-8   4) fr_FR.UTF-8"
            echo "    5) es_ES.UTF-8   6) it_IT.UTF-8"
            echo "    7) pt_BR.UTF-8   8) ja_JP.UTF-8"
            echo "    9) Other (type manually)"
            read -p "  Select [1-9]: " locale_pick
            case "$locale_pick" in
                1) NEW_LOCALE="en_US.UTF-8" ;;
                2) NEW_LOCALE="en_GB.UTF-8" ;;
                3) NEW_LOCALE="de_DE.UTF-8" ;;
                4) NEW_LOCALE="fr_FR.UTF-8" ;;
                5) NEW_LOCALE="es_ES.UTF-8" ;;
                6) NEW_LOCALE="it_IT.UTF-8" ;;
                7) NEW_LOCALE="pt_BR.UTF-8" ;;
                8) NEW_LOCALE="ja_JP.UTF-8" ;;
                9) read -p "  Enter locale (e.g. en_US.UTF-8): " NEW_LOCALE ;;
                *) NEW_LOCALE="" ;;
            esac
            if [ -n "$NEW_LOCALE" ]; then
                sudo sed -i "s/^# *${NEW_LOCALE}/${NEW_LOCALE}/" /etc/locale.gen 2>/dev/null
                sudo locale-gen 2>/dev/null
                sudo localectl set-locale LANG="$NEW_LOCALE"
                echo "  ✓ Locale set to $NEW_LOCALE"
            fi
        fi

        echo ""
        # === DETECT HARDWARE ===
        echo "Detecting hardware..."
        echo ""
        detect_hardware
        
        echo ""
        echo "========================================="
        echo "  Installing Packages"
        echo "========================================="
        echo ""

        # === DESKTOP EXTRAS ===
        # These are NOT installed by desktop.sh (which only does the base:
        # sway, fuzzel, kitty, NM, pipewire, greetd). Install them now.
        echo "Installing desktop extras..."
        echo ""

        DESKTOP_PKGS=(
            swayidle gtklock
            mako
            grim slurp wl-clipboard cliphist
            brightnessctl autotiling wob
            xwayland python3-i3ipc wget
            libspa-0.2-bluetooth rfkill
            pavucontrol
            bluez blueman bluez-tools
            gvfs gvfs-backends
            adwaita-qt
            xdg-desktop-portal-wlr
            lxpolkit
            pcmanfm
            papirus-icon-theme
            btop htop
            zram-tools
        )

        # x86-only extras
        ARCH=$(uname -m)
        if [[ "$ARCH" == "x86_64" ]]; then
            DESKTOP_PKGS+=(bluez-firmware qt5-style-plugins)
        fi

        sudo apt update
        sudo apt install -y "${DESKTOP_PKGS[@]}" || {
            echo "  ⚠ Some packages failed to install. Continuing..."
        }
        echo "  ✓ Desktop extras installed"
        
        # === HARDWARE-SPECIFIC PACKAGES ===
        echo ""
        echo "Installing hardware-specific packages..."
        echo ""

        # Nvidia drivers
        if [ "$GPU_TYPE" = "NVIDIA" ]; then
            echo "  Checking repositories for non-free-firmware..."
            if ! grep -q "non-free-firmware" /etc/apt/sources.list; then
                echo "  Adding non-free-firmware repo..."
                safe_sources_add_components /etc/apt/sources.list "contrib non-free non-free-firmware"
                sudo apt update
            fi
            
            echo "  Installing NVIDIA drivers..."
            sudo apt install -y nvidia-driver firmware-misc-nonfree 2>/dev/null || {
                echo "  Note: Driver install failed. Check logs."
            }
            
            # Set Nvidia Wayland environment
            mkdir -p "$HOME/.config/environment.d"
            echo "WLR_NO_HARDWARE_CURSORS=1" > "$HOME/.config/environment.d/tebian-nvidia.conf"
            echo "LIBVA_DRIVER_NAME=nvidia" >> "$HOME/.config/environment.d/tebian-nvidia.conf"
            echo "  NVIDIA environment configured"
        fi
        
        # AMD GPU firmware
        if [ "$GPU_TYPE" = "AMD" ]; then
            echo "  Installing AMD firmware..."
            sudo apt install -y firmware-amd-graphics firmware-linux-nonfree 2>&1 || echo "  ⚠ Optional package failed: $?"
        fi
        
        # Intel GPU firmware
        if [ "$GPU_TYPE" = "Intel" ]; then
            echo "  Installing Intel firmware..."
            sudo apt install -y firmware-misc-nonfree 2>&1 || echo "  ⚠ Optional package failed: $?"
        fi
        
        # CPU microcode
        if [ "$CPU_TYPE" = "Intel" ]; then
            echo "  Installing Intel microcode..."
            sudo apt install -y intel-microcode 2>&1 || echo "  ⚠ Optional package failed: $?"
        elif [ "$CPU_TYPE" = "AMD" ]; then
            echo "  Installing AMD microcode..."
            sudo apt install -y amd64-microcode 2>&1 || echo "  ⚠ Optional package failed: $?"
        fi
        
        # Laptop power management
        if [ "$IS_LAPTOP" = true ]; then
            echo "  Installing laptop power management (TLP)..."
            sudo apt install -y tlp powertop 2>&1 || echo "  ⚠ Optional package failed: $?"
            sudo systemctl enable tlp 2>/dev/null || true
            echo "  TLP enabled for battery optimization"
        fi
        
        # === CONFIGURE DESKTOP EXPERIENCE ===
        echo ""
        echo "========================================="
        echo "  Configuring Desktop"
        echo "========================================="
        echo ""
        
        # Create mako config
        mkdir -p "$HOME/.config/mako"
        echo "default-timeout=5000" > "$HOME/.config/mako/config"
        echo "  Notifications configured"

        # WOB (volume/brightness overlay)
        TEBIAN_DIR="$HOME/Tebian"
        mkdir -p "$HOME/.config/wob"
        if [ -f "$TEBIAN_DIR/configs/wob/wob.ini" ]; then
            cp "$TEBIAN_DIR/configs/wob/wob.ini" "$HOME/.config/wob/wob.ini"
            echo "  WOB overlay configured"
        fi

        # XDG Desktop Portal
        mkdir -p "$HOME/.config/xdg-desktop-portal"
        if [ -f "$TEBIAN_DIR/configs/xdg-desktop-portal/sway-portals.conf" ]; then
            cp "$TEBIAN_DIR/configs/xdg-desktop-portal/sway-portals.conf" "$HOME/.config/xdg-desktop-portal/"
            echo "  XDG portal configured"
        fi

        # ZRAM swap
        if command -v zramctl &>/dev/null; then
            echo -e "ALGO=zstd\nPERCENT=60" | sudo tee /etc/default/zramswap > /dev/null 2>&1 || true
            sudo systemctl restart zramswap 2>/dev/null || true
            echo "  ZRAM swap configured"
        fi

        # Setup gtklock styling
        tebian-lockscreen-setup
        echo "  Screen lock configured"

        # Fix greetd to use cage for gtkgreet login screen
        if [ -f /etc/greetd/config.toml ] && grep -q "\"gtkgreet" /etc/greetd/config.toml && ! grep -q "cage" /etc/greetd/config.toml; then
            sudo sed -i "s|command = \"gtkgreet|command = \"cage -s -- gtkgreet|" /etc/greetd/config.toml
            echo "  Login greeter configured"
        fi

        # Enable floating mode by default (familiar experience)
        setup_floating_mode
        idempotent_append "default_border normal 2 # tebian-titlebars" "$HOME/.config/sway/config.user"
        idempotent_append "default_floating_border normal 2 # tebian-titlebars" "$HOME/.config/sway/config.user"
        idempotent_append "focus_follows_mouse yes # tebian-floating-mode" "$HOME/.config/sway/config.user"
        echo "  Floating mode with title bars enabled"
        
        # Apply default theme (Nord) so kitty/fuzzel/mako have sane configs
        if command -v tebian-theme &>/dev/null; then
            echo "  Applying default theme..."
            tebian-theme nord
            echo "  Default theme (Nord) applied"
        else
            # Fallback: copy base kitty.conf from repo
            mkdir -p "$HOME/.config/kitty"
            if [ -f "$HOME/Tebian/configs/kitty/kitty.conf" ]; then
                cp "$HOME/Tebian/configs/kitty/kitty.conf" "$HOME/.config/kitty/kitty.conf"
                echo "  Kitty config copied"
            fi
        fi

        # Disable SSH on desktop (unnecessary attack surface for a laptop)
        if systemctl is-active --quiet ssh 2>/dev/null; then
            sudo systemctl disable --now ssh 2>/dev/null
            echo "  SSH disabled (re-enable in Settings > Security)"
        fi

        # QT theme integration (use GTK theme for consistency)
        mkdir -p "$HOME/.config/environment.d"
        idempotent_append "QT_QPA_PLATFORMTHEME=gtk2" "$HOME/.config/environment.d/tebian-qt.conf"
        echo "  QT theme integration configured"

        # HiDPI scaling (idempotent)
        if [ "$IS_HIDPI" = true ]; then
            idempotent_append "# HiDPI scaling" "$HOME/.config/sway/config.user"
            idempotent_append "output * scale 2" "$HOME/.config/sway/config.user"
            idempotent_append "GDK_SCALE=2" "$HOME/.profile"
            echo "  HiDPI scaling enabled (2x)"
        fi
        
        echo ""
        echo "========================================="
        echo "  Desktop Mode Ready!"
        echo "========================================="
        echo ""
        echo "Installed:"
        echo "  - Desktop essentials"
        if [ "$GPU_TYPE" = "NVIDIA" ]; then
            echo "  - NVIDIA drivers"
        fi
        if [ "$CPU_TYPE" = "Intel" ] || [ "$CPU_TYPE" = "AMD" ]; then
            echo "  - $CPU_TYPE microcode"
        fi
        if [ "$IS_LAPTOP" = true ]; then
            echo "  - Laptop power management"
        fi
        if [ "$IS_HIDPI" = true ]; then
            echo "  - HiDPI scaling"
        fi
        echo ""
        echo "Press Enter to finish..."
        read
    '
    
    # Make bar always visible
    swaymsg 'bar mode dock' 2>/dev/null || true
    
    # Save preference and clean up progress flag
    echo "desktop" > "$ONBOARD_FILE"
    rm -f "$PROGRESS_FILE"
    log "Desktop setup complete"
    
elif [[ "$CHOICE" =~ "Base" ]]; then
    log "User chose Base mode"
    echo "base" > "$ONBOARD_FILE"
    rm -f "$PROGRESS_FILE"
    notify-send "Tebian" "Base mode selected. Install what you need via fuzzel." 2>/dev/null || true
    
elif [ -z "$CHOICE" ]; then
    # Track dismissals - after 3, stop asking
    DISMISS_FILE="$HOME/.config/tebian/.onboard_dismissed"
    DISMISS_COUNT=0
    [ -f "$DISMISS_FILE" ] && DISMISS_COUNT=$(cat "$DISMISS_FILE" 2>/dev/null)
    DISMISS_COUNT=$((DISMISS_COUNT + 1))
    echo "$DISMISS_COUNT" > "$DISMISS_FILE"
    if [ "$DISMISS_COUNT" -ge 3 ]; then
        log "User dismissed 3 times, marking as base mode"
        echo "base" > "$ONBOARD_FILE"
    else
        log "User dismissed ($DISMISS_COUNT/3), will ask again next boot"
    fi
    exit 0
fi

log "Onboarding complete"
