---
import Layout from '../layouts/Layout.astro';

const files = {
	'install.sh': `#!/bin/bash
# Usage: curl -sL tebian.org/install | bash
# For ARM / Pi / existing Debian installs

set -euo pipefail

TEBIAN_DIR="$HOME/Tebian"
TEBIAN_REPO="https://github.com/tebian-os/tebian.git"

echo ""
echo "  ┌───────────────┐"
echo "  │  T E B I A N  │"
echo "  └───────────────┘"
echo ""

if [ ! -f /etc/debian_version ]; then
    echo "Error: Tebian requires a Debian-based system"
    exit 1
fi

if ! command -v git &>/dev/null; then
    sudo apt update -qq && sudo apt install -y -qq git
fi

git clone --depth 1 "$TEBIAN_REPO" "$TEBIAN_DIR"
exec bash "$TEBIAN_DIR/bootstrap.sh"`,

	'tebian-installer': `#!/bin/bash
# Tebian Installer — runs from live USB
# Catppuccin-themed whiptail TUI

# Catppuccin Mocha theme
export NEWT_COLORS='
root=white,black
border=cyan,black
title=cyan,black
window=white,black
button=black,cyan
actbutton=white,blue
listbox=white,black
actlistbox=black,cyan
'

# Step 1: Select disk
DISK=\$(whiptail --menu "Select disk" 18 70 10 \\
    /dev/sda "500GB SSD" \\
    /dev/nvme0n1 "1TB NVMe" \\
    3>&1 1>&2 2>&3)

# Step 2: Partition strategy
# Detects Windows → offers "Install alongside"
MODE=\$(whiptail --menu "Partition" 18 70 10 \\
    alongside "Install alongside Windows" \\
    erase "Erase disk" \\
    manual "Manual (advanced)" \\
    3>&1 1>&2 2>&3)

# Step 3: Optional LUKS encryption
whiptail --yesno "Enable encryption?" 8 40

# Step 4: User + hostname
USERNAME=\$(whiptail --inputbox "Username:" 8 40 \\
    3>&1 1>&2 2>&3)

# Step 5: Desktop or Server?
MODE=\$(whiptail --menu "System mode" 18 70 10 \\
    desktop "Tebian Desktop (Sway + audio)" \\
    server  "Server (headless)" \\
    3>&1 1>&2 2>&3)

# Server submenu
# server-bare:   SSH + pure Debian
# server-secure: SSH + UFW + fail2ban + monitoring

# Step 6: debootstrap → chroot → GRUB → done
debootstrap trixie /mnt http://deb.debian.org/debian
# ... install packages, configure, reboot`,

	'desktop.sh': `#!/bin/bash
# Tebian Base Installer (V3.0)
# Installs minimum GUI: Sway, fuzzel, kitty, pipewire, greetd
# Desktop extras installed by tebian-onboard if user picks "Desktop"

set -euo pipefail

sudo apt update

# Base packages — minimum for sway + onboard fuzzel menu
sudo apt install -y \\
    sway swaybg \\
    fuzzel \\
    kitty \\
    pipewire wireplumber pipewire-pulse \\
    fonts-noto fonts-jetbrains-mono \\
    network-manager \\
    curl \\
    greetd gtkgreet cage libnotify-bin

# Copy configs
mkdir -p ~/.config/sway ~/.config/kitty ~/.config/fuzzel
cp ~/Tebian/configs/sway/config ~/.config/sway/
cp ~/Tebian/configs/themes/glass/kitty.conf ~/.config/kitty/
cp ~/Tebian/configs/themes/glass/fuzzel.ini ~/.config/fuzzel/

# Install scripts to ~/.local/bin/
cp ~/Tebian/scripts/* ~/.local/bin/
chmod +x ~/.local/bin/*

# Enable graphical login
sudo systemctl enable greetd

echo "Done. Reboot for graphical login."`,

	'status.sh': `#!/bin/bash
# Zero-Fork Status Bar — pure bash, reads /sys and /proc
# Auto-detects: backlight, battery, WiFi, Bluetooth, GPU

# Hardware detection (once at startup)
BACKLIGHT_DEV=\$(ls /sys/class/backlight/ | head -1)
WIFI_IF=\$(ls /sys/class/net/ | grep -E '^wl' | head -1)
BAT_DEV=\$(ls /sys/class/power_supply/ | grep -i bat | head -1)

while true; do
    # 1s: time + capslock
    printf -v date_str '%(%a %d %b %H:%M)T' -1

    # 5s: brightness, memory, GPU, volume
    if [ \$((counter % 5)) -eq 0 ]; then
        read -r cur < /sys/class/backlight/\$BACKLIGHT_DEV/actual_brightness
        read -r max < /sys/class/backlight/\$BACKLIGHT_DEV/max_brightness
        bright=\$((cur * 100 / max))
        vol_raw=\$(wpctl get-volume @DEFAULT_AUDIO_SINK@)
    fi

    # 10s: WiFi signal strength
    # 30s: disk usage, bluetooth, battery

    echo "\$wifi | \$vol | \$bright | \$bat | \$date_str"
    sleep 1
done`
};

const fileNames = Object.keys(files);
---

<Layout title="Source — Tebian">
	<main>
		<div class="editor">
			<div class="tabs">
				{fileNames.map((file, i) => (
					<button class={`tab ${i === 0 ? 'active' : ''}`} data-file={file}>
						{file}
					</button>
				))}
			</div>
			<div class="code-container">
				<div class="line-numbers" id="line-numbers"></div>
				<pre class="code"><code id="code-content"></code></pre>
			</div>
		</div>

		<a href="https://github.com/tebian-os" target="_blank" class="github-link" title="View on GitHub">
			<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/></svg>
		</a>

		<div class="nav">
			<a href="/">← Home</a>
			<span class="nav-divider">|</span>
			<a href="/docs">Docs</a>
			<a href="/blog">Blog</a>
			<a href="/manifesto">Manifesto</a>
			<a href="/reasoning">Reasoning</a>
			<a href="/honors">Honors</a>
		</div>
	</main>
</Layout>

<script define:vars={{ files }}>
	const codeContent = document.getElementById('code-content');
	const lineNumbers = document.getElementById('line-numbers');
	const tabs = document.querySelectorAll('.tab');

	function showFile(fileName) {
		const code = files[fileName];
		codeContent.textContent = code;

		const lines = code.split('\n').length;
		lineNumbers.innerHTML = Array.from({ length: lines }, (_, i) =>
			`<span>${i + 1}</span>`
		).join('');

		tabs.forEach(tab => {
			tab.classList.toggle('active', tab.dataset.file === fileName);
		});

		// Reset scroll to top
		document.querySelector('.code-container').scrollTop = 0;
	}

	tabs.forEach(tab => {
		tab.addEventListener('click', () => showFile(tab.dataset.file));
	});

	// Load first file
	showFile('tebian-installer');
</script>

<style>
	main {
		min-height: 100vh;
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		padding: 2rem;
	}

	.editor {
		background: #11111b;
		border-radius: 12px;
		overflow: hidden;
		box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
		max-width: 800px;
		width: 100%;
		max-height: 70vh;
		display: flex;
		flex-direction: column;
	}

	.tabs {
		display: flex;
		background: #181825;
		border-bottom: 1px solid #313244;
		padding: 0 0.5rem;
		overflow-x: auto;
		gap: 0;
		flex-shrink: 0;
	}

	.tab {
		padding: 0.75rem 1rem;
		font-size: 0.85rem;
		color: #6c7086;
		background: none;
		border: none;
		border-bottom: 2px solid transparent;
		cursor: pointer;
		white-space: nowrap;
		transition: all 0.2s;
		font-family: inherit;
		border-radius: 0;
	}

	.tab:hover {
		color: #9399b2;
		background: rgba(255, 255, 255, 0.02);
	}

	.tab.active {
		color: #cdd6f4;
		border-bottom-color: #89b4fa;
		background: rgba(137, 180, 250, 0.05);
	}

	.code-container {
		display: flex;
		overflow: auto;
		flex: 1;
	}

	.line-numbers {
		display: flex;
		flex-direction: column;
		padding: 1.25rem 0;
		background: #181825;
		color: #45475a;
		font-size: 0.85rem;
		text-align: right;
		min-width: 3rem;
		user-select: none;
	}

	.line-numbers span {
		padding: 0 0.75rem;
		line-height: 1.5;
	}

	.code {
		margin: 0;
		padding: 1.25rem;
		font-size: 0.85rem;
		line-height: 1.5;
		flex: 1;
		white-space: pre;
		color: #cdd6f4;
	}

	.github-link { color: #6c7086; margin-top: 1.5rem; transition: color 0.2s; }
	.github-link:hover { color: #cdd6f4; }

	.nav {
		margin-top: 1rem;
		display: flex;
		gap: 1.5rem;
		align-items: center;
	}

	.nav a {
		color: #6c7086;
		text-decoration: none;
		font-size: 1rem;
		transition: color 0.2s;
	}

	.nav a:hover {
		color: var(--accent-color);
	}

	.nav-divider {
		color: #313244;
	}
</style>
